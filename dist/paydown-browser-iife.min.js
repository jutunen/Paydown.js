const Paydown=function(){function t(){this.event_array=[],this.sum_of_interests=0,this.sum_of_reductions=0,this.latest_calculated_interest_date="",this.latest_payment_date="",this.current_rate="",this.current_recurring_payment=null,this.current_principal="",this.g_p_i_sum_of_interests=0,this.total_number_of_days=0,this.g_p_i_total_days=0,this.payment_log_array=[],this.debug_log_array=[],this.day_count_divisor=0,this.latest_period_end_date=0,this.init={},this.round_values=!0,this.initial_fee=0,this.sum_of_fees=0,this.current_recurring_fee=0,this.current_single_fee=0,this.recurring_payment_period=1,this.rateHashMap={},this.round=function(t){if("number"!=typeof t||isNaN(t))throw new Error("this.round illegal parameter type");return this.round_values&&(t=u(t)),t},this.log_payment=function(t){this.payment_logging_enabled&&(10!==t[0].length&&(t[0]=a(t[0])),this.payment_log_array.push(t))},this.get_period_interests=function(t,e,i,a){var s,_=0;if(!t)throw new Error("this.get_period_interests invalid parameter: principal");if(!i)throw new Error("this.get_period_interests invalid parameter: start_date");if(!a)throw new Error("this.get_period_interests invalid parameter: end_date");if(n(i)>n(a))throw new Error("this.get_period_interests invalid date: start_date "+i+" is after end_date "+a);this.latest_period_end_date&&(1!==h(this.latest_period_end_date,i,!0)&&r("Date difference is not one day as expected, latest_period_end_date: "+this.latest_period_end_date+" start_date: "+i));var o=h(i,a);if(this.total_number_of_days+=o,this.debug_logging_enabled&&this.debug_log_period_start(i,o,t,e),this.rateHashMap.hasOwnProperty(n(i))&&(e=this.rateHashMap[n(i)],this.log_payment([i,e,"-","-","-",this.round(t),"-"])),this.debug_logging_enabled&&this.debug_log("Interest rate: "+e),s=this.get_first_event_after_date("rate",i,a)){for(var d,u,l=i,c=s.date,y=e;s;)d=h(l,c,!0),this.g_p_i_total_days+=d,u=t*(y/100)*(d/this.day_count_divisor),this.debug_logging_enabled&&this.debug_log_subperiod(d,u,s.date,s.rate),_+=u,y=s.rate,this.log_payment([s.date,s.rate,"-","-","-",this.round(t),"-"]),l=c,(s=this.get_first_event_after_date("rate",c,a))&&(c=s.date);d=h(c,a),this.g_p_i_total_days+=d,u=t*(y/100)*(d/this.day_count_divisor),this.debug_logging_enabled&&this.debug_log_subperiod(d,u),_+=u,this.current_rate=y}else d=h(i,a),this.g_p_i_total_days+=d,u=t*(e/100)*(d/this.day_count_divisor),this.debug_logging_enabled&&this.debug_log("Period daily interest: ",u/d),_+=u,this.current_rate=e;return this.debug_logging_enabled&&this.debug_log("Period total interest: ",_),this.g_p_i_sum_of_interests+=_,this.latest_period_end_date=a,_},this.get_first_event_after_date=function(t,e,r){for(var i=0;i<this.event_array.length;i++){if(n(this.event_array[i].date)>n(e)&&this.event_array[i].hasOwnProperty(t)&&n(this.event_array[i].date)<=n(r))return this.event_array[i];if(n(this.event_array[i].date)>n(r))return!1}return!1},this.check_if_date_has_event=function(t,e){for(var r=0;r<this.event_array.length;r++)if(n(this.event_array[r].date)===n(e))return!!this.event_array[r].hasOwnProperty(t)&&this.event_array[r];return!1},this.check_date=function(t,e){if(e||(e=""),!t)throw new Error("this.check_date: "+e+" date is missing");if("string"!=typeof t)throw new Error("this.check_date: "+e+" date must be of type string: "+t);if(!function(t){var e=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);if(!e)return!1;var r=Number(e[1]),i=Number(e[2]),n=Number(e[3]);if(i<1||i>12)return!1;var a=d(i,n);if(r<1||r>a)return!1;return!0}(t))throw new Error("this.check_date: "+e+" date is invalid: "+t)},this.handle_last_payment=function(t,e,r,i=0){var n;t+=this.current_principal,n=this.round(t+r),this.sum_of_reductions+=t,this.log_payment([e,this.current_rate,n,this.round(t),this.round(r),0,this.round(i)]),this.current_principal=0,this.latest_payment_date=e},this.func_pay_installment=function(t,e,r,i=0){var n,a,s,_;if(this.latest_calculated_interest_date===this.event_array[t].date?n=0:(s=e.set_current(this.latest_calculated_interest_date).get_next(),_=this.event_array[t].date,n=this.get_period_interests(this.current_principal,this.current_rate,s,_)),(a=0===r?0:r-n)<0)throw new Error("Exception: installment "+this.round(r)+" is too small to cover the interest "+this.round(n)+": "+s+" - "+_);return this.sum_of_interests+=n,this.current_principal-=a,this.latest_calculated_interest_date=this.event_array[t].date,this.latest_payment_date=this.event_array[t].date,this.current_principal<=0?(this.handle_last_payment(a,this.event_array[t].date,n,i),!1):(this.sum_of_reductions+=a,this.log_payment([this.event_array[t].date,this.current_rate,this.round(a+n),this.round(a),this.round(n),this.round(this.current_principal),this.round(i)]),!0)},this.func_pay_reduction=function(t,e,r,i=0){var n;return n=this.latest_calculated_interest_date===this.event_array[t].date?0:this.get_period_interests(this.current_principal,this.current_rate,e.set_current(this.latest_calculated_interest_date).get_next(),this.event_array[t].date),this.sum_of_interests+=n,this.current_principal-=r,this.latest_calculated_interest_date=this.event_array[t].date,this.latest_payment_date=this.event_array[t].date,this.current_principal<=0?(this.handle_last_payment(r,this.event_array[t].date,n,i),!1):(this.sum_of_reductions+=r,this.log_payment([this.event_array[t].date,this.current_rate,this.round(r+n),this.round(r),this.round(n),this.round(this.current_principal),this.round(i)]),!0)},this.calculate_to_date=function(t,i){var n,a,s,_=0;if("number"!=typeof this.init.principal||isNaN(this.init.principal))throw new Error("this.calculate_to_date: principal must be number");if(0===this.init.principal)throw new Error("this.calculate_to_date: principal is missing");if("number"!=typeof this.init.rate||isNaN(this.init.rate))throw new Error("this.calculate_to_date: rate must be number");Array.isArray(t)?this.payment_logging_enabled=!0:this.payment_logging_enabled=!1,Array.isArray(i)?this.debug_print_to_console=!1:this.debug_print_to_console=!0,this.sum_of_interests=0,this.sum_of_reductions=0,this.g_p_i_sum_of_interests=0;var h=new e;if(this.check_date(this.init.start_date,"start"),this.check_date(this.init.end_date,"end"),null!==this.current_recurring_payment&&(this.check_first_payment_date(),this.generate_payment_events_till(this.init.end_date)),this.add_event({date:this.init.end_date,ending:!0}),this.merge_events(),this.check_events(),"act/360"===this.init.day_count_method)this.day_count_divisor=360;else{if("act/365"!==this.init.day_count_method)throw new Error("invalid day count method: "+this.init.day_count_method);this.day_count_divisor=365}for(this.latest_calculated_interest_date=h.set_current(this.init.start_date).get_prev(),this.latest_period_end_date=this.latest_calculated_interest_date,this.total_number_of_days=0,this.g_p_i_total_days=0,this.log_payment([this.init.start_date,this.init.rate,"-","-","-",this.init.principal,this.initial_fee]),this.current_principal=this.init.principal,this.current_rate=this.init.rate,this.sum_of_fees=this.initial_fee,n=0;n<this.event_array.length;n++){if(this.event_array[n].hasOwnProperty("recurring_amount")){if(null===this.current_recurring_payment)throw new Error("Can't do recurring_amount: initial recurring data missing or invalid!");this.current_recurring_payment=this.event_array[n].recurring_amount}if(this.event_array[n].hasOwnProperty("recurring_fee_amount")){if(null===this.current_recurring_payment)throw new Error("Can't do recurring_fee_amount: initial recurring data missing or invalid!");this.current_recurring_fee=this.event_array[n].recurring_fee_amount}if(this.event_array[n].hasOwnProperty("pay_single_fee")?(this.sum_of_fees+=this.event_array[n].pay_single_fee,this.current_single_fee=this.event_array[n].pay_single_fee):this.current_single_fee=0,this.event_array[n].hasOwnProperty("payment_method"))if("equal_installment"===this.event_array[n].payment_method)this.init.payment_method="equal_installment";else{if("equal_reduction"!==this.event_array[n].payment_method)throw new Error("invalid payment method in event: "+this.event_array[n].payment_method);this.init.payment_method="equal_reduction"}if(this.event_array[n].hasOwnProperty("pay_recurring")){if(null===this.current_recurring_payment)throw new Error("Can't do pay_recurring: initial recurring data missing or invalid!");if(this.sum_of_fees+=this.current_recurring_fee,"equal_installment"===this.init.payment_method){if(!this.func_pay_installment(n,h,this.current_recurring_payment,this.current_recurring_fee))break}else{if("equal_reduction"!==this.init.payment_method)throw new Error("invalid payment method: "+this.init.payment_method);if(!this.func_pay_reduction(n,h,this.current_recurring_payment,this.current_recurring_fee))break}}if(this.event_array[n].hasOwnProperty("pay_reduction")&&this.event_array[n].hasOwnProperty("pay_installment"))throw new Error("main loop error: event can not have more than one single payment on "+this.event_array[n].date);if(this.event_array[n].hasOwnProperty("pay_reduction")){if(a=this.event_array[n].pay_reduction,!this.func_pay_reduction(n,h,a,this.current_single_fee))break}else if(this.event_array[n].hasOwnProperty("pay_installment")){if(s=this.event_array[n].pay_installment,!this.func_pay_installment(n,h,s,this.current_single_fee))break}else this.current_single_fee&&(this.event_array[n].hasOwnProperty("ending")||(this.log_payment([this.event_array[n].date,this.current_rate,"-","-","-",this.round(this.current_principal),this.round(this.current_single_fee)]),this.current_single_fee=0));if(this.event_array[n].hasOwnProperty("ending")){this.event_array[n].hasOwnProperty("pay_reduction")||this.event_array[n].hasOwnProperty("pay_recurring")||this.event_array[n].hasOwnProperty("pay_installment")?this.latest_calculated_interest_date=this.latest_payment_date:(_=this.get_period_interests(this.current_principal,this.current_rate,h.set_current(this.latest_calculated_interest_date).get_next(),this.event_array[n].date),this.sum_of_interests+=_,this.log_payment([this.event_array[n].date,this.current_rate,"-","-",this.round(_),this.round(this.current_principal),this.round(this.current_single_fee)]),this.latest_calculated_interest_date=this.init.end_date);break}}if(this.round(this.g_p_i_sum_of_interests)!==this.round(this.sum_of_interests)&&r("Sum of interests mismatch: "+this.round(this.g_p_i_sum_of_interests)+" vs. "+this.round(this.sum_of_interests)),this.g_p_i_total_days!==this.total_number_of_days&&r("Day count mismatch, this.g_p_i_total_days: "+this.g_p_i_total_days+" this.total_number_of_days: "+this.total_number_of_days),this.payment_logging_enabled)for(let e=0;e<this.payment_log_array.length;e++)t.push(this.payment_log_array[e]);if(this.debug_logging_enabled&&!this.debug_print_to_console)for(let t=0;t<this.debug_log_array.length;t++)i.push(this.debug_log_array[t]);return[this.sum_of_interests,this.sum_of_reductions,this.current_principal,this.latest_calculated_interest_date,this.latest_payment_date,_,this.sum_of_fees]},this.set_init=function(t){if("object"!=typeof t||null===t)throw new Error("this.set_init: invalid or missing init_obj");if(this.init.start_date=t.start_date,this.init.end_date=t.end_date,this.init.principal=t.principal,this.init.rate=t.rate,t.hasOwnProperty("day_count_method")?this.init.day_count_method=t.day_count_method:this.init.day_count_method="act/360",t.hasOwnProperty("recurring")){if(!t.recurring.hasOwnProperty("amount")||!l(t.recurring.amount))throw new Error("this.set_init: invalid or missing recurring amount");if(this.current_recurring_payment=t.recurring.amount,!t.recurring.hasOwnProperty("first_payment_date"))throw new Error("this.set_init: missing first recurring payment date");if(this.init.first_payment_date=t.recurring.first_payment_date,!t.recurring.hasOwnProperty("payment_day")||!l(t.recurring.payment_day)||t.recurring.payment_day<1||t.recurring.payment_day>31||!Number.isInteger(t.recurring.payment_day))throw new Error("this.set_init: invalid or missing first payment_day number");if(this.init.payment_day=t.recurring.payment_day,t.recurring.hasOwnProperty("payment_method")?this.init.payment_method=t.recurring.payment_method:this.init.payment_method="equal_installment",t.recurring.hasOwnProperty("payment_fee")){if(!l(t.recurring.payment_fee))throw new Error("this.set_init: invalid recurring payment_fee");this.current_recurring_fee=t.recurring.payment_fee}if(t.recurring.hasOwnProperty("payment_period")){if(!l(t.recurring.payment_period)||t.recurring.payment_period>12||!Number.isInteger(t.recurring.payment_period))throw new Error("this.set_init: invalid recurring payment_period");this.recurring_payment_period=t.recurring.payment_period}}else this.current_recurring_payment=null;if(t.hasOwnProperty("round_values")?this.round_values=t.round_values:this.round_values=!0,t.hasOwnProperty("debug_logging")?this.debug_logging_enabled=t.debug_logging:this.debug_logging_enabled=!1,t.hasOwnProperty("initial_fee")){if(!l(t.initial_fee))throw new Error("this.set_init: invalid initial fee");this.initial_fee=t.initial_fee}else this.initial_fee=0},this.check_and_add_event=function(t){if(!t.hasOwnProperty("date"))throw new Error("this.add_event: date missing from event");if(this.check_date(t.date,"event"),t.hasOwnProperty("rate")&&(isNaN(t.rate)||"number"!=typeof t.rate))throw new Error("this.check_and_add_event: invalid rate in event "+t.date);if(t.hasOwnProperty("recurring_amount")&&!l(t.recurring_amount))throw new Error("this.check_and_add_event: invalid recurring_amount in event "+t.date);if(t.hasOwnProperty("pay_installment")&&("number"!=typeof t.pay_installment||t.pay_installment<=0||isNaN(t.pay_installment)))throw new Error("this.check_and_add_event: invalid pay_installment in event "+t.date);if(t.hasOwnProperty("pay_reduction")&&("number"!=typeof t.pay_reduction||t.pay_reduction<=0||isNaN(t.pay_reduction)))throw new Error("this.check_and_add_event: invalid pay_reduction in event "+t.date);if(t.hasOwnProperty("recurring_fee_amount")&&!l(t.recurring_fee_amount))throw new Error("this.check_and_add_event: invalid recurring_fee_amount in event "+t.date);if(t.hasOwnProperty("pay_single_fee")&&!l(t.pay_single_fee))throw new Error("this.check_and_add_event: invalid pay_single_fee in event "+t.date);this.event_array.push(Object.assign({},t))},this.add_event=function(t){if(!t.hasOwnProperty("date"))throw new Error("this.add_event: date missing from event");this.event_array.push(Object.assign({},t))},this.merge_events=function(){this.event_array.sort(i);for(var t=0;t<this.event_array.length-1;t++)this.event_array[t].hasOwnProperty("rate")&&(this.rateHashMap[n(this.event_array[t].date)]=this.event_array[t].rate),n(this.event_array[t].date)===n(this.event_array[t+1].date)&&(Object.assign(this.event_array[t],this.event_array[t+1]),this.event_array.splice(t+1,1),t-=1)},this.check_first_payment_date=function(){if(this.check_date(this.init.first_payment_date,"1st recurring payment"),n(this.init.first_payment_date)<=n(this.init.start_date))throw new Error("this.check_first_payment_date: first payment date must be after start date")},this.generate_payment_events_till=function(t){var r=new e(this.init.first_payment_date),i={date:r.get_current(),pay_recurring:!0};for(this.add_event(i);n(r.get_nth_month_nth_day(this.recurring_payment_period,this.init.payment_day))<=n(t);)i={date:r.get_current(),pay_recurring:!0},this.add_event(i)},this.check_events=function(){for(var t=0;t<this.event_array.length-1;t++)if(n(this.event_array[t].date)<=n(this.init.start_date))throw new Error("this.check_events: event date ("+this.event_array[t].date+") before start date not allowed")},this.debug_log_period_start=function(t,e,r,i){this.debug_write("New period starts "+t),this.debug_write("Days in period: "+e),this.debug_write("Remaining principal: "+this.round(r))},this.debug_log_subperiod=function(t,e,r,i){this.debug_write("Subperiod days: "+t),this.debug_write("Subperiod daily interest: "+this.round(e/t)),this.debug_write("Subperiod total interest: "+this.round(e)),r&&this.debug_write("Rate changes "+r+", new rate is "+i)},this.debug_log=function(t,e){var r;r=e,isNaN(parseFloat(r))||!isFinite(r)?this.debug_write(t):this.debug_write(t,this.round(e))},this.debug_write=function(t,e=""){this.debug_print_to_console?console.log(t,e):this.debug_log_array.push(t+e)}}function e(t){t&&(this.date=t,this.split_table=this.date.split("."),this.day=Number(this.split_table[0]),this.month=Number(this.split_table[1]),this.year=Number(this.split_table[2])),this.get_current=function(){return s(this.day)+"."+s(this.month)+"."+this.year},this.set_current=function(t){return this.split_table=t.split("."),this.day=Number(this.split_table[0]),this.month=Number(this.split_table[1]),this.year=Number(this.split_table[2]),this},this.get_next=function(){var t=new Date(this.year,this.month-1,this.day);return t.setDate(t.getDate()+1),this.day=String(t.getDate()),this.month=String(t.getMonth()+1),this.year=String(t.getFullYear()),s(this.day)+"."+s(this.month)+"."+this.year},this.get_prev=function(){var t=new Date(this.year,this.month-1,this.day);return t.setDate(t.getDate()-1),this.day=String(t.getDate()),this.month=String(t.getMonth()+1),this.year=String(t.getFullYear()),s(this.day)+"."+s(this.month)+"."+this.year},this.get_nth_month_nth_day=function(t,e){if(1===t&&(31===e||1===this.month&&e>28))return this.get_next_month_last_day();var r=this.month+t,i=this.year;return r>12&&(r-=12,++i),this.day=31===e?d(r,i):e,this.month=r,this.year=i,s(e)+"."+s(r)+"."+i},this.get_next_month_last_day=function(){var t=this.month,e=this.year;12===t?(t=1,++e):++t;var r=d(t,e);return this.day=r,this.month=t,this.year=e,r+"."+s(this.month)+"."+this.year}}function r(t){throw new Error("Unexpected exception: "+t)}function i(t,e){return n(t.date)>n(e.date)?1:n(t.date)<n(e.date)?-1:0}function n(t){var e=_(t)[0],r=_(t)[1],i=_(t)[2];return e=s(Number(e)),r=s(Number(r)),Number(i+r+e)}function a(t){if("string"!=typeof t)throw new Error("zero_fill_date illegal parameter type");if(!t)return"N/A";var e=_(t)[0],r=_(t)[1],i=_(t)[2];return(e=s(Number(e)))+"."+(r=s(Number(r)))+"."+i}function s(t){return(t<10?"0":"")+t}function _(t){var e=t.split(".");return[e[0],e[1],e[2]]}function h(t,e,r){var i;i=r?0:1;var n=t.split("."),a=e.split("."),s=new Date(Number(n[2]),Number(n[1])-1,Number(n[0])),_=new Date(Number(a[2]),Number(a[1]-1),Number(a[0]));return Math.round((_-s)/864e5)+i}function o(t){return t%4==0&&t%100!=0||t%400==0}function d(t,e){return 1===t||3===t||5===t||7===t||8===t||10===t||12===t?31:4===t||6===t||9===t||11===t?30:2===t&&o(e)?29:2!==t||o(e)?void r("days_in_month"):28}function u(t){return t=Math.round(100*t)/100}function l(t){return!(isNaN(t)||"number"!=typeof t||t<0)}return new function(){this.calculate=function(e,r,i,n){var s=new t;s.set_init(e);var _,h,o,d,l,c,y,p,g=[];for(r&&(g=r.slice());g[0];)s.check_and_add_event(g.shift());try{[_,h,o,d,l,c,y]=s.calculate_to_date(i,n)}catch(t){throw t}return e.hasOwnProperty("round_values")?e.round_values?(p=u(_+h-c),_=u(_),h=u(h),o=u(o),c=u(c),y=u(y)):p=_+h-c:(p=u(_+h-c),_=u(_),h=u(h),o=u(o),c=u(c),y=u(y)),{sum_of_interests:_,sum_of_reductions:h,sum_of_installments:p,remaining_principal:o,days_calculated:s.total_number_of_days,actual_end_date:a(d),latest_payment_date:a(l),unpaid_interest:c,sum_of_fees:y}}}}();